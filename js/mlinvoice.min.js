/*! mlinvoice 2021-04-06 */

var MLInvoice=function o(){var a=[],n=!1,i={},t="none",r=[],d=!0,c=2,s={},l="dd.mm.yyyy";function p(e,t){i[e]=t}function u(e,t,a){var n=i[e]||e;return n===e&&void 0!==a&&(n=a),"object"==typeof t&&$.each(t,function(e,t){n=n.replace(new RegExp(e,"g"),t)}),n}function f(){var e=s;return e.singleDatePicker=!0,e.ranges=null,e.showCustomRangeLabel=!1,e.autoApply=!0,e}function v(e,t){if(!e)return null;var a=void 0===t?"":t;return moment(e,l).format("YYYY"+a+"MM"+a+"DD")}function m(e){return new String(e).replace(",",".")}function h(e,t){var a=void 0===t?c:t,n=u("DecimalSeparator"),i=u("ThousandSeparator",[],""),o=parseFloat(e).toFixed(a).replace(".",n);if(i){for(var r=o.split(n),d=new RegExp("(\\d+)(\\d{3})"+n+"?");d.test(r[0]);)r[0]=r[0].replace(d,"$1"+i+"$2");o=r[0],1<r.length&&(o+=n+r[1])}return o}function e(){$.getJSON("json.php?func=noop").done(function(){window.setTimeout(e,6e4)})}function _(e){return $("#spinner").addClass("hidden"),409==e.status?b(JSON.parse(e.responseText).warnings):b("Error trying to access the server: "+e.status+" - "+e.statusText),!1}function g(e){var t=void 0===e?$("body"):$(e);0===t.find(".cb-select-row:checked").length?(t.find(".selected-row-button").attr("disabled","disabled"),t.find(".selected-row-button").addClass("disabled")):(t.find(".selected-row-button").removeAttr("disabled"),t.find(".selected-row-button").removeClass("disabled"))}function y(e,t,a){var n=$('<div class="toast align-items-center" role="alert" aria-live="polite" aria-atomic="true">');void 0!==a?n.addClass(a):n.addClass("text-white bg-success");var i=$('<div class="d-flex">').appendTo(n);$('<div class="toast-body">').text(e).appendTo(i),$('<button type="button" class="btn-close m-auto me-2" data-bs-dismiss="toast">').attr("aria-label",u("Close")).appendTo(i);var o=$("#toasts");0===o.length&&(o=$('<div id="toasts" aria-live="polite" class="toast-container position-fixed p-3 top-0 end-0" style="z-index: 5">').appendTo($("body"))),n.appendTo(o);var r={autohide:void 0!==t,delay:void 0!==t?t:0};new bootstrap.Toast(n.get(0),r).show()}function b(e,t){y(e,t,"text-white bg-danger")}function w(e,t){var a=function(e,t){for(var a=e.split("."),n=t.split(".");a.length<n.length;)a.push(0);for(;n.length<a.length;)n.push(0);for(var i=0;i<a.length;i++)if(a[i]!==n[i])return parseInt(a[i])>parseInt(n[i])?1:-1;return 0}(e.version,t);if(0<a){var n=u("UpdateAvailableTitle",{"{version}":e.version,"{date}":e.date}),i=$("<span/>").attr("title",n).text(u("UpdateAvailable")+" ");$("<br/>").appendTo(i),$("<a/>").attr("href",e.url).text(u("UpdateInformation")).appendTo(i),$("<br/>").appendTo(i),$("<a/>").attr("href","index.php?func=system&operation=update").text(u("UpdateNow")).appendTo(i),i.appendTo("#version")}else a<0&&$("<span/>").text(u("PrereleaseVersion")).appendTo("#version");Cookies.set("updateversion",JSON.stringify(e),{expires:1})}function T(e){var t=$("#popup_dlg .modal-body");t.html(e),t.find("form").on("submit",function(e){var t=$(this),a=t.attr("method")||"GET",n=t.attr("action")||"",i=new FormData(this);return $.ajax({type:a,url:n,processData:!1,contentType:!1,data:i,success:function(e){T(e)},error:function(){o.errormsg("Request failed")}}),e.preventDefault(),!1}),t.find("a").off("click").on("click",function(e){var t=$(this).attr("href");return $.get(t,T).fail(function(){o.errormsg("Request failed")}),e.preventDefault(),!1})}function I(e,t){var a=$(e),n="primary";a.hasClass("btn-secondary")&&(n="secondary"),t?a.removeClass("btn-outline-"+n).addClass("btn-"+n).addClass("text-light"):a.removeClass("btn-"+n).removeClass("text-light").addClass("btn-outline-"+n)}function k(e){var t=$(e);return t.hasClass("btn-primary")||t.hasClass("btn-secondary")}return{init:function(){$("input.hasCalendar").each(function(){var e=f();$(this).data("noFuture")&&(e.maxDate=moment()),$(this).daterangepicker(e)}),$("input.date").each(function(){$(this).data("noFuture")&&$(this).on("change",function(){var e=$(this).val();10===e.length&&new Date(v(e,"-"))>new Date&&b(u("FutureDateEntered"))})}),$("#admin_form").find('input[type="text"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').on("change",function(){I(".save_button",!0)}),$(window).on("beforeunload",function(e){if(k(".save_button")||k(".row-add-button"))return e.returnValue=u("UnsavedData"),e.returnValue}),$(document).ajaxStart(function(){$("#spinner").removeClass("hidden")}),$(document).ajaxStop(function(){$("#spinner").addClass("hidden")}),$(document).ajaxError(function(e,t){_(t)}),d&&window.setTimeout(e,6e4),$(".cb-select-all").off("click").on("click",function(){var e=$(this).closest("table");e.find(".cb-select-row").prop("checked",$(this).prop("checked")),g(e.closest(".list_container"))}),$("#cover-letter-button").on("click",function(){$("#cover-letter-form").toggleClass("hidden")}),$("#cover-letter-form .close-btn").on("click",function(){$("#cover-letter-form").addClass("hidden")}),$("#add-custom-prices").on("click",function(){$("#no-custom-prices").addClass("hidden"),$("#custom-prices-form").removeClass("hidden")}),$("#custom-prices-form .save-button").on("click",function(){var e=$("#custom-prices-form"),t={company_id:$("#company_id").val(),discount:m(e.find("#discount").val()),multiplier:m(e.find("#multiplier").val()),valid_until:v(e.find("#valid_until").val())};return $.ajax({url:"json.php?func=put_custom_prices",type:"POST",dataType:"json",data:JSON.stringify(t),contentTypes:"application/json; charset=utf-8",success:function(){y(u("RecordSaved"),2e3),window.location.reload()}}),!1}),$("#custom-prices-form .delete-button").on("click",function(){if(confirm(u("ConfirmDelete"))){var e={company_id:$("#company_id").val()};return $.ajax({url:"json.php?func=delete_custom_prices",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(){y(u("RecordDeleted"),2e3),window.location.reload()}}),!1}}),$(".print-selected-rows .print-selected-item").on("click",function(){var e=$(this).closest(".list_container").find(".cb-select-row:checked").map(function(){return"id[]="+encodeURIComponent(this.value)}).get(),t="invoice.php?template="+encodeURIComponent($(this).data("templateId"))+"&"+e.join("&");return"openwindow"===$(this).data("style")?window.open(t):window.location.href=t,!1}),$(".form-submit").on("click",function(){var e=$(this),t=e.data("confirm");if(t&&!confirm(u(t)))return!1;var a=e.data("form"),n=a?$("#"+a):$("form"),i=e.data("formTarget");void 0!==i&&n.attr("target",i);var o=e.data("setField");if(void 0!==o){var r="1",d=o.split("=",2);2===d.length&&(o=d[0],r=d[1]),n.find("[name="+o+"]").val(r)}return I(".save_button",!1),n.trigger("submit"),!1}),$("button.popup-close").on("click",function(){return window.close(),!1}),$("[data-form-cancel]").on("click",function(){window.opener?window.close():history.back()}),$("a.update-dates").on("click",function(){return $.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#invoice_date").val(e.date),$("#due_date").val(e.due_date),$("#next_interval_date").val(e.next_interval_date),I(".save_button",!0)}),!1}),$("a.update-invoice-nr").on("click",function(){return $.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#invoice_no").val(e.invoice_no),$("#ref_number").val(e.ref_no),I(".save_button",!0)}),!1}),n=!0},addTranslation:p,addTranslations:function(e){for(var t in e)"string"==typeof e[t]&&p(t,e[t])},setDispatchNotePrintStyle:function(e){t=e},getDispatchNotePrintStyle:function(){return t},setDatePickerDefaults:function(e){s=e},getDatePickerDefaults:f,getDateRangePickerDefaults:function(){return s},setOfferStates:function(e){r=e},isOfferStatus:function(e){return-1!==r.indexOf(e)},translate:u,formatCurrency:h,setKeepAlive:function(e){d=e},updateRowSelectedState:g,infomsg:y,errormsg:b,editUnitPrice:function(){return n=this,i=$(n),o=i.parents("tr"),r=i.parents("table").dataTable(),d=i.text(),c=r.fnGetData(o),s=function(){i.text(d),i.removeClass("editing")},l=function(){var e=i.find("input");e.css("width",i.innerWidth()-36+"px"),i.append('<i class="icon-spinner animate-spin"></i>');var a=String(e.val());if(a!==d){var t={company_id:$("#company_id").val(),product_id:c[0],unit_price:m(a)};$.ajax({url:"json.php?func="+(""===a?"delete_custom_price":"put_custom_price"),type:"POST",dataType:"json",data:JSON.stringify(t),contentType:"application/json; charset=utf-8",success:function(e){i.removeClass("editing");var t=null!==e.unit_price?h(e.unit_price):r.fnGetData(i.prev().get(0));""===a?(i.text(t),o.removeClass("custom-price")):(i.text(t),o.addClass("custom-price"))},error:function(){i.text(a),i.removeClass("editing")}})}else s()},e=$("<input/>").attr("type","text").attr("value",d).css("width",i.innerWidth()-24+"px").on("keydown",function(e){if(13===e.which)$(this).data("handled",!0),l();else if(27===e.which)$(this).data("handled",!0),s();else if(9===e.which){var t=$("td.editable"),a=t.index(n);return e.shiftKey?0<a&&$(t[a-1]).trigger("click"):t.length>a+1&&$(t[a+1]).trigger("click"),!1}}).on("click",function(){return!1}).on("blur",function(){$(this).data("handled")||l()}),i.empty().addClass("editing").append(e),e.trigger("select").trigger("focus"),!1;var n,i,o,r,d,c,s,l,e},setCurrencyDecimals:function(e){c=e},setDateFormat:function(e){l=e.toUpperCase()},checkForUpdates:function(e,t){Cookies.get("updateversion")&&Cookies.get("currentversion")===t?w(JSON.parse(Cookies.get("updateversion")),t):$.getJSON(e+"?callback=?",function(e){w(e,t),Cookies.set("currentversion",t)})},calcRowSum:function(e){var t=e.partial_payment?1:e.pcs,a=e.price,n=e.discount||0,i=e.discount_amount||0,o=e.vat;a*=1-n/100,a-=i;var r=0,d=0,c=0;return 1===Number(e.vat_included)?c=(d=t*a)-(r=d/(1+o/100)):d=(r=t*a)+(c=r*(o/100)),{sum:r,VAT:c,sumVAT:d}},popupDialog:function(e,t,a){var n=$("#popup_dlg");return n.find(".modal-body").html('<i class="icon-spinner animate-spin"></i>'),n.find(".modal-title").text(a),n.off("hidden.bs.modal").on("hidden.bs.modal",t),new bootstrap.Modal(n.get(0)).show(),$.get(e,T).fail(function(){o.errormsg("Dialog contents could not be loaded")}),!0},clearMessages:function(){$("#toasts").html("")},ajaxErrorHandler:_,parseDate:v,formatDate:function(e){var t=new String(e);return 8===t.length&&(t=t.substr(0,4)+"-"+t.substr(4,2)+"-"+t.substr(6,2)),moment(t).format(l)},addModule:function(e,t){void 0===this[e]&&(a.push(e),this[e]="function"==typeof t?t():t,n&&this[e].init&&this[e].init())},initTableExportButtons:function(e){new $.fn.dataTable.Buttons(e,{buttons:["copy","csv",$.extend(!0,{},{exportOptions:{format:{body:function(e,t,a,n){var i=$(n).data("export");if(void 0!==i)return i;var o=$(n).data("sort");return void 0!==o?o:e}}}},{extend:"excelHtml5"}),"pdf"]}).container().appendTo($("#DataTables_Table_0_length"))},highlightButton:I,updateBaseLogo:function(){var t=$("#logo"),a=$("#no_logo"),e=$("#record_id").val();e&&$.get("json.php?func=get_base&id="+e,function(e){e.logo_filename&&e.logo_filesize&&e.logo_filetype&&e.logo_filedata?(t.find("img").attr("src","data:image/"+e.logo_filetype+";base64,"+e.logo_filedata),t.removeClass("hidden"),a.addClass("hidden")):(t.addClass("hidden"),a.removeClass("hidden"))})}}}();MLInvoice.addModule("Form",function(){var u={},f={},r={},p=null,v=null,l=0;function d(){-1<navigator.userAgent.toLowerCase().indexOf("android")||$("textarea.markdown").each(function(){var e=new EasyMDE({element:this,minHeight:"50px",autoDownloadFontAwesome:!1,indentWithTabs:!1,forceSync:!1,spellChecker:!1,status:!1,toolbarTips:!1,toolbar:[{name:"bold",action:EasyMDE.toggleBold,className:"icon-bold",title:"Bold"},{name:"italic",action:EasyMDE.toggleItalic,className:"icon-italic",title:"Italic"},{name:"headingc",action:EasyMDE.toggleHeadingSmaller,className:"icon-header",title:"Heading"},"|",{name:"blockquote",action:EasyMDE.toggleBlockquote,className:"icon-quote-left",title:"Quote"},{name:"unordered-list",action:EasyMDE.toggleUnorderedList,className:"icon-list-bullet",title:"Unordered list"},{name:"ordered-list",action:EasyMDE.toggleOrderedList,className:"icon-list-numbered",title:"Ordered list"},"|",{name:"preview",action:EasyMDE.togglePreview,className:"icon-eye",title:"Preview"},{name:"side-by-side",action:EasyMDE.toggleSideBySide,className:"icon-columns",title:"Side by side"},{name:"fullscreen",action:EasyMDE.toggleFullScreen,className:"icon-resize-full-alt",title:"Full screen"},"|"]});e.codemirror.options.extraKeys.Tab=!1,e.codemirror.options.extraKeys["Shift-Tab"]=!1,$(this).data("mde",e),e.codemirror.on("change",function(){k(),MLInvoice.highlightButton(".save_button",!0)})})}function c(){var e=$("#update_stock_balance");new bootstrap.Modal(e.get(0)).show()}function s(){$.ajax({url:"json.php?func=update_stock_balance",type:"POST",data:{product_id:$("#record_id").val(),stock_balance_change:document.getElementById("stock_balance_change").value.replace(MLInvoice.translate("DecimalSeparator"),"."),stock_balance_change_desc:document.getElementById("stock_balance_change_desc").value},success:function(e){if(e.missing_fields)alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields);else{var t=parseFloat(e.new_stock_balance).toFixed(2).replace(".",MLInvoice.translate("DecimalSeparator"));$("#stock_balance").val(t),a(),bootstrap.Modal.getInstance($("#update_stock_balance").get(0)).hide()}}})}function a(){$("#stock_balance_change_log  > tbody > tr").slice(1).remove(),$.ajax({url:"json.php?func=get_stock_balance_rows",type:"POST",data:{product_id:$("#record_id").val()},success:function(e){$("#stock_balance_change_log").append(e)}})}function m(){var e=$("#base_id.linked");""==e.val()?$("#base_id_label").text($("#base_id_label").text()):$("#base_id_label").html('<a href="index.php?func=settings&list=base&form=base&id='+e.val()+'">'+$("#base_id_label").text()+"</a>")}function h(){var e=$("#company_id.linked");0!==e.length&&(""===e.val()?$("#company_id_label").text($("#company_id_label").text()):$("#company_id_label").html('<a href="index.php?func=company&list=&form=company&id='+e.val()+'">'+$("#company_id_label").text()+"</a>"))}function _(i){$("#company_id").val(i.businessId).trigger("change"),$("#company_name").val(i.name),$.each(i.addresses,function(e,t){if(1===t.version&&(1===t.type&&($("#street_address").val(t.street),$("#zip_code").val(t.postCode),$("#city").val(t.city),$("#country").val(t.country)),2===t.type)){var a=[];if(a.push(i.name),t.careOf&&a.push("c/o "+t.careOf),t.street&&a.push(t.street),t.postCode){var n=t.postCode+" "+t.city;a.push(n.trim())}t.country&&a.push(t.country),$("#billing_address").val(a.join("\n"))}}),$.each(i.contactDetails,function(e,t){if(1===parseInt(t.version,10))switch(t.type){case"Matkapuhelin":$("#gsm").val(t.value);break;case"Kotisivun www-osoite":$("#www").val(t.value);break;case"Puhelin":$("#phone").val(t.value);break;case"Faksi":$("#fax").val(t.value)}})}function g(){$(".select-default-text").each(function(){var n=$(this).data("target"),i=$(this).data("sendFormParam"),t=$('<input type="hidden" class="select-default-text"/>').appendTo($(this));t.select2({placeholder:"",ajax:{url:"json.php",dataType:"json",quietMillis:200,data:function(e,t){return{func:"get_selectlist",table:"default_value",q:e,type:$(this).parent().data("type"),pagelen:50,page:t}},results:function(e){return{results:e.records,more:e.moreAvailable}}},dropdownCssClass:"bigdrop",dropdownAutoWidth:!0,escapeMarkup:function(e){return e},width:"element",minimumResultsForSearch:-1}),t.on("change",function(){var e=t.select2("val");e&&(t.select2("val",null),$.ajax({url:"json.php",data:{func:"get_default_value",id:e}}).done(function(e){if(i){var t=$('<input type="hidden"/>');t.attr("name",i),t.attr("value",e.id),$("#"+n).append(t),$("#"+n).submit()}else{var a=$("#"+n).data("mde");a?a.value(e.content):($("#"+n).val(e.content),$("#"+n).trigger("change"))}}).fail(function(e,t){window.alert("Request failed: "+e.status+" - "+t)}))})})}function y(e){var c={_onChangeCompany:b,_onChangeCompanyOffer:t,_onChangeProduct:n,_onChangeCompanyReload:i};$(void 0===e?"body":e).find(".select2").each(function(){var i=$(this);if(i.attr("id")){var e=$("label[for="+i.attr("id")+"]");e.length&&e.attr("for","s2id_"+e.attr("for"))}var n=i.hasClass("tags"),o=i.data("query"),r=i.data("showEmpty"),t=i.data("onChange"),a={placeholder:"",ajax:{url:"json.php?func=get_selectlist&"+o,dataType:"json",quietMillis:200,data:function(e,t){var a={q:e,pagelen:50,page:t};if("iform_product_id"===i[0].id){var n=$("#company_id");n.length&&n.val()&&(a.company=n.val())}return a},results:function(e,t){var a=[];return n?$(e.records).each(function(){a.push({id:this.text,text:this.text,descriptions:[]})}):a=e.records,r&&1===t&&""===e.filter&&a.unshift({id:"",text:"-"}),{results:a,more:e.moreAvailable}}},initSelection:function(e,t){var a=$(e).val();""!==a&&$.ajax("json.php?func=get_selectlist&"+o+"&id="+a,{dataType:"json"}).done(function(e){t(e.records[0])})},formatResult:function(e){var t=e.text;return $(e.descriptions).each(function(){t+='<div class="select-description">'+this+"</div>"}),t},dropdownCssClass:"bigdrop",dropdownAutoWidth:!0,escapeMarkup:function(e){return e},width:"style"};n&&$.extend(a,{tags:!0,tokenSeparators:[","],createSearchChoice:function(e){return{id:$.trim(e),text:$.trim(e)+" (+)"}},initSelection:function(e,t){var a=[],n=e.val();if(!n)return a;$(n.split(",")).each(function(){""!==$.trim(this)&&a.push({id:this,text:this})}),t(a)},formatSelection:function(e){var t=e.text;return t=t.replace(/ \(\+\)$/,""),$("<div/>").text(t).html()}});var d=i.select2(a);t&&"function"==typeof c[t]&&d.on("change",c[t])})}function b(e){var t=void 0===e;$("#invoice_vatless").val("0"),o(""),$.getJSON("json.php?func=get_company",{id:$("#company_id").val()},function(e){e&&(t||(e.default_ref_number&&$("#ref_number").val(e.default_ref_number),e.delivery_terms_id&&$("#delivery_terms_id").val(e.delivery_terms_id),e.delivery_method_id&&$("#delivery_method_id").val(e.delivery_method_id),e.payment_days&&$.getJSON("json.php?func=get_invoice_defaults",{id:$("#record_id").val(),invoice_no:$("#invoice_no").val(),invoice_date:$("#invoice_date").val(),base_id:$("#base_id").val(),company_id:$("#company_id").val(),interval_type:$("#interval_type").val()},function(e){$("#due_date").val(e.due_date)}),$("#delivery_address").val(e.delivery_address?e.delivery_address:"")),e.info&&o(e.info),e.invoice_default_foreword&&$("#foreword").val(e.invoice_default_foreword),e.invoice_default_afterword&&$("#afterword").val(e.invoice_default_afterword),e.invoice_vatless&&$("#invoice_vatless").val("1"))})}function t(){o(""),$.getJSON("json.php?func=get_company",{id:$("#company_id").val()},function(e){e&&(e.info&&o(e.info),e.offer_default_foreword&&$("#foreword").val(e.offer_default_foreword),e.offer_default_afterword&&$("#afterword").val(e.offer_default_afterword))})}function n(){if(""!==this.value){var l=this.form.id,e=$("#company_id").val();$.getJSON("json.php?func=get_product&id="+this.value+"&company_id="+e,function(e){if((p=e)&&e.id){var t=new Event("change");if(""!==e.description||document.getElementById(l+"_description").value===(null!==v?v:"")){var a=document.getElementById(l+"_description");a.value=e.description,a.dispatchEvent(t)}v=e.description;for(var n=document.getElementById(l+"_type_id"),i=0;i<n.options.length;i++){var o=n.options[i];if(o.value===(null===e.type_id?"":String(e.type_id))){o.selected=!0,n.dispatchEvent(t);break}}var r=e.custom_price&&null!==e.custom_price.unit_price?e.custom_price.unit_price:e.unit_price,d=document.getElementById(l+"_price");d.value=e.unit_price?MLInvoice.formatCurrency(r):"",d.dispatchEvent(t),(d=document.getElementById(l+"_discount")).value=e.discount?e.discount.replace(".",","):"",d.dispatchEvent(t),(d=document.getElementById(l+"_discount_amount")).value=e.discount_amount?MLInvoice.formatCurrency(e.discount_amount):"",d.dispatchEvent(t);var c=document.getElementById(l+"_vat"),s=document.getElementById(l+"_vat_included");"0"===$("#invoice_vatless").val()?(d=document.getElementById(l+"_vat"),c.value=e.vat_percent?e.vat_percent.replace(".",","):"",s.checked=!(!e.vat_included||1!==e.vat_included)):(c.value="0",s.checked=!1),c.dispatchEvent(t),s.dispatchEvent(t)}})}}function i(){var e=window.location.href;e=e.replace(/[\\?&]company=\d*/,""),e+=0<=e.indexOf("?")?"&":"?",e+="company="+this.value,window.location.href=e}function o(e){e?$("<span/>").addClass("info").attr("title",e).text(" ").on("click",function(){alert(e)}).appendTo($("#company_id_label")):$("#company_id_label>span.info").remove()}function w(){var a=$(".send-buttons");if(0!==a.length){a.html("").addClass("hidden");var e=String($("#base_id").val());""!==e&&$.getJSON("json.php?func=get_send_api_services",{invoice_id:String($("#record_id").val()),base_id:e},function(e){$.each(e.services,function(e,t){$('<a class="btn btn-secondary dropdown-toggle" href="#" role="button" id="dropdown-button-send-'+e+'" data-bs-toggle="dropdown" aria-expanded="false">').text(t.name+"...").appendTo(a);var n=$('<ul class="dropdown-menu" aria-labelledby="dropdown-button-send-'+e+'">');$.each(t.items,function(e,t){var a=$('<li class="dropdown-item">').text(t.name);a.on("click",function(){!function(e){if(!T())return;void 0===$("#admin_form").data("readOnly")?MLInvoice.Form.saveRecord(e,"",!0):window.location.href=e}("?"+t.href)}),n.append(a)}),a.append(n),a.append(" "),a.removeClass("hidden")})})}}function T(){var e=$("#admin_form");if(void 0!==e.data("checkInvoiceDate")){var t=new Date,a=$("#invoice_date").val().split(".");if((parseInt(a[0],10)!==t.getDate()||parseInt(a[1],10)!==t.getMonth()+1||parseInt(a[2],10)!==t.getYear()+1900)&&!confirm(MLInvoice.translate("InvoiceDateNonCurrent")))return!1}if(!MLInvoice.isOfferStatus($("#state_id").val())){var n=$("#ref_number").val().length;if(0<n&&n<4&&!confirm(MLInvoice.translate("InvoiceRefNumberTooShort")))return!1;if(void 0!==e.data("checkInvoiceNumber")){var i=String($("#invoice_no").val());if((""===i||"0"===i)&&!confirm(MLInvoice.translate("InvoiceNumberNotDefined")))return!1}}return!0}function I(){var e=$("#attachments-form").data("invoiceId"),s=$("<div/>");l=0,$.getJSON("json.php?func=get_invoice_attachments&parent_id="+e,function(e){var c=0;$.each(e.records,function(e,t){c+=1,t.order_no>l&&(l=t.order_no);var a=$("<div/>").addClass("attachment");$('<a role="button" class="btn btn-primary btn-sm remove-attachment">').text(" X ").attr("title",MLInvoice.translate("RemoveAttachment")).on("click",function(){$.getJSON("json.php?func=delete_invoice_attachment&id="+t.id,function(){I()})}).appendTo(a);var n=$("<input>").attr("type","checkbox").data("id",t.id).prop("checked",t.send);n.on("change",function(){$.ajax({url:"json.php?func=put_invoice_attachment",data:{id:$(this).data("id"),send:$(this).prop("checked")?"1":"0"},type:"POST",dataType:"json"})});var i=$("<label/>").addClass("attachment-send");n.appendTo(i),$("<span/>").text(" "+MLInvoice.translate("SendToClient")).appendTo(i),i.appendTo(a);var o=$("<input/>").addClass("form-control attachment-name").attr("type","text").data("id",t.id).val(t.name).attr("placeholder",MLInvoice.translate("Description"));o.on("change",function(){$.ajax({url:"json.php?func=put_invoice_attachment",data:{id:$(this).data("id"),name:$(this).val()},type:"POST",dataType:"json"})}),o.appendTo(a);var r=$("<div/>").addClass("attachment-fileinfo");$("<a/>").attr("href","attachment.php?type=invoice&id="+t.id).attr("target","_blank").text(t.filename).appendTo(r);var d=$("<span/>").text(" ("+t.filesize_readable+")");1048576<t.filesize&&(d.addClass("large-file"),d.attr("title",MLInvoice.translate("LargeFile"))),d.appendTo(r),r.appendTo(a),a.appendTo(s)}),0===c&&s.text(MLInvoice.translate("NoEntries")),$(".attachment-list").empty().append(s),$(".attachment-count").text(c)})}function k(){"invoice"===u.type&&!u.modificationWarningShown&&u.modificationWarning&&(alert(u.modificationWarning),u.modificationWarningShown=!0)}function x(){var e=$("#quick_add_company");new bootstrap.Modal(e.get(0)).show()}function S(){var e={};e.company_name=document.getElementById("quick_name").value,e.company_id=document.getElementById("quick_vat_id").value,e.email=document.getElementById("quick_email").value,e.phone=document.getElementById("quick_phone").value,e.street_address=document.getElementById("quick_street_address").value,e.zip_code=document.getElementById("quick_zip_code").value,e.city=document.getElementById("quick_city").value,e.country=document.getElementById("quick_country").value,$.ajax({url:"json.php?func=put_company",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){var t;e.missing_fields?alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(t=e.id,$.getJSON("json.php?func=get_company",{id:t},function(e){var t=e.company_name;e.company_id&&(t+=" ("+e.company_id+")");var a=$("#company_id");a.select2("data",{id:e.id,text:t}),a.trigger("change")}),bootstrap.Modal.getInstance($("#quick_add_company").get(0)).hide())}})}function C(){var e=$("#add_partial_payment");new bootstrap.Modal(e.get(0)).show()}function M(){$.getJSON("json.php?func=add_reminder_fees&id="+$("#record_id").val(),function(e){e.errors?MLInvoice.errormsg(e.errors):MLInvoice.infomsg(MLInvoice.translate("ReminderFeesAdded")),MLInvoice.Form.initRows()})}function E(){var e={};e.invoice_id=$("#record_id").val(),e.description=MLInvoice.translate("PartialPayment"),e.row_date=$("#add_partial_payment_date").val(),e.price=-parseFloat($("#add_partial_payment_amount").val().replace(MLInvoice.translate("DecimalSeparator"),".")),e.pcs=0,e.vat=0,e.vat_included=0,e.order_no=1e5,e.partial_payment=1,$.ajax({url:"json.php?func=put_invoice_row",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?alert(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(MLInvoice.Form.initRows(),bootstrap.Modal.getInstance($("#add_partial_payment").get(0)).hide())}})}function L(){w();var e=String($("#base_id").val());""!==e&&$.ajax({url:"json.php?func=get_base",data:{id:e},type:"GET",success:function(i){var e=$("#state_id").val();$.ajax({url:"json.php?func=get_invoice_state",data:{id:e},type:"GET",success:function(e){if(0!=e.invoice_open){var t=1==e.invoice_offer?"offer":"invoice";if(i[t+"_default_foreword"]){var a=$("#foreword").val();""!==a&&a!==i.invoice_default_foreword&&a!==i.offer_default_foreword||$("#foreword").val(i[t+"_default_foreword"])}if(i[t+"_default_afterword"]){var n=$("#afterword").val();""!==n&&n!==i.invoice_default_afterword&&n!==i.offer_default_afterword||$("#afterword").val(i[t+"_default_afterword"])}i.invoice_default_info&&""==$("#info").val()&&$("#info").val(i.invoice_default_info)}}})}})}return{initForm:function(e,t,a){f=t,r=a,(u=e).modificationWarningShown=!1,$("#admin_form").find('input[type="text"]:not([name="payment_date"]),input[type="hidden"],input[type="checkbox"]:not([name="archived"]),select:not(.dropdownmenu),textarea').one("change",k),$(".save_button").on("click",function(){return MLInvoice.Form.saveRecord(),!1}),$("#base_id").on("change",L),$("#state_id").on("change",L),$("#company_id.select2").val()&&b(),$(".update-stock-balance").on("click",c),$("#base_id.linked").on("change",m),m($("#base_id.linked")),$("#company_id.linked").on("change",h),h($("#company_id.linked")),$("[data-add-reminder-fees]").on("click",M),$("[data-add-partial-payment]").on("click",C),$("[data-save-partial-payment]").on("click",E),$("[data-quick-add-company]").on("click",x),$("[data-save-company]").on("click",S),$("[data-save-stock-balance-change]").on("click",s);var n,i=this;$("[data-iform-copy-row]").on("click",function(){return i.saveRow($(this).data("iform-copy-row"),!0),!1}),$("[data-iform-save-row]").on("click",function(){return i.saveRow($(this).data("iform-save-row")),!1}),$("[data-iform-delete-row]").on("click",function(){return!0===confirm(MLInvoice.translate("ConfirmDelete"))&&i.deleteRow($(this).data("iform-delete-row")),!1}),$("[data-iform-save-rows]").on("click",function(){return i.modifyRows($(this).data("iform-save-rows")),!1}),$(".modification-indicator .clear").on("click",function(){var e=$(this).closest(".modification-indicator");e.addClass("hidden");var t=e.closest("td");t.find('input[type="text"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').data("modified",0),t.find('input[type="text"],input[type="hidden"]:not(.select-default-text),textarea').val(""),t.find('input[type="checkbox"]').prop("checked",!1),t.find("select:not(.dropdownmenu)").val(""),t.find("input.select2").select2("val",null)}),o=$("a.ytj_search_button"),0!==o.length&&o.on("click",function(){var a=$("#company_id").val();if(a||(a=$("#company_name").val()),""!==(a=window.prompt(MLInvoice.translate("SearchYTJPrompt"),a))&&null!==a){var e=a.replace(/FI-?/i,"");$.ajax({url:"https://avoindata.prh.fi/bis/v1",data:{maxResults:1,businessId:e},global:!1}).done(function(e){void 0!==e.results[0]&&_(e.results[0])}).fail(function(e,t){404===e.status?$.ajax({url:"https://avoindata.prh.fi/bis/v1",data:{maxResults:1,name:a},global:!1}).done(function(e){void 0!==e.results[0]&&_(e.results[0])}).fail(function(e,t){404===e.status?window.alert(MLInvoice.translate("NoYTJResultsFound")):window.alert("Request failed: "+e.status+" - "+t)}):window.alert("Request failed: "+e.status+" - "+t)})}}),d(),g(),y(),n=$("#attachments-form").data("invoiceId"),$("#attachments-button").on("click",function(){$(this).attr("aria-expanded","true"===$(this).attr("aria-expanded")?"false":"true"),$("#attachments-form").hasClass("hidden")&&I(),$("#attachments-button .dropdown-open").toggleClass("hidden"),$("#attachments-button .dropdown-close").toggleClass("hidden"),$("#attachments-form").toggleClass("hidden")}),$("a.add-attachment").on("click",function(){$.ajax({url:"json.php?func=add_invoice_attachment&id="+$(this).data("id")+"&invoice_id="+n,type:"POST",dataType:"json",success:function(){I()}})}),$("#new-attachment-file").on("change",function(){if(0<this.files.length){var e=new FormData;e.append("filedata",this.files[0]),e.append("invoice_id",n),e.append("order_no",l+5),$.ajax({url:"json.php?func=put_invoice_attachment",type:"POST",dataType:"json",data:e,processData:!1,contentType:!1,success:function(e){e.warnings&&alert(e.warnings),e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):I()}}),$(this).val(null)}}),w(),$("[data-print-id]").on("click",function(){var e=$(this),t=e.data("print-id"),a=e.data("func"),n=e.data("print-style");MLInvoice.Form.printInvoice(t,a,n)});var o},initAddressAutocomplete:function(a){var t=document.getElementById(a+"street_address");if(null!==t){$(t).attr("placeholder",""),$(t).blur(function(){var e=$(t).val();setTimeout(function(){$(t).val(e)},0)});var n=new google.maps.places.Autocomplete(t,{types:["geocode"]});google.maps.event.addListener(n,"place_changed",function(){var e=n.getPlace();setTimeout(function(){$("#"+a+"street_address").val(e.name),$.each(e.address_components,function(e,t){0<=$.inArray("postal_code",t.types)?$("#"+a+"zip_code").val(t.long_name).trigger("change"):0<=$.inArray("locality",t.types)||0<=$.inArray("administrative_area_level_3",t.types)?$("#"+a+"city").val(t.long_name).trigger("change"):0<=$.inArray("country",t.types)&&$("#"+a+"country").val(t.long_name).trigger("change")})},0)})}},saveRecord:function(a,n,i){MLInvoice.clearMessages();var o=$("#admin_form"),r=new FormData;$.each(u.fields,function(e,t){var a=o.find("[name="+t.name+"]");switch(t.type){case"CHECK":r.append(t.name,a.prop("checked"));break;case"INT":r.append(t.name,a.val().replace(MLInvoice.translate("DecimalSeparator"),"."));break;case"FILE":0<a.get(0).files.length&&r.append(t.name,a.get(0).files[0]);break;case"SELECT":case"SEARCHLIST":case"INTDATE":case"LIST":case"TEXT":case"PASSWD":case"TAGS":r.append(t.name,a.val());break;case"AREA":if(a.hasClass("markdown")){var n=a.data("mde");r.append(t.name,void 0!==n?n.value():a.val())}else r.append(t.name,a.val())}}),r.append("id",o.find("#record_id").val()),void 0!==i&&r.append("onPrint",i),$.ajax({url:"json.php?func=put_"+u.type,type:"POST",dataType:"json",data:r,processData:!1,contentType:!1,success:function(e){if(e.warnings&&alert(e.warnings),e.missing_fields)MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields);else if("invoice"===u.type&&void 0!==i&&i&&($("input#invoice_no").val(e.invoice_no),$("input#ref_number").val(e.ref_number)),MLInvoice.highlightButton(".save_button",!1),MLInvoice.infomsg(MLInvoice.translate("RecordSaved"),2e3),a&&("openwindow"===n?window.open(a):window.location=a),!o.find("#record_id").val()&&(o.find("#record_id").val(e.id),!a||"openwindow"===n)){var t=new String(window.location).split("#",1)[0];window.location=t+"&id="+e.id}}})},initRows:function(c){$(".cb-select-all").prop("checked",!1);var e="";switch(f.type){case"company":e="get_companies";break;case"company_contact":e="get_company_contacts";break;case"invoice_row":e="get_invoice_rows";break;case"send_api_config":e="get_send_api_configs"}var s=u.readOnly,l=u.type,h=f,_=r,p=this;$.getJSON("json.php?func="+e+"&parent_id="+u.id,function(e){var t=$("#itable");$("#itable > tbody > tr[id!=form_row]").remove(),$("#itable > tfoot").remove();var o=t.find("tbody");if($.each(e.records,function(e,v){var m=$("<tr/>").addClass("item-row");if(!s&&"invoice"===l){$('<td class="sort-col"><span class="sort-handle"><i class="icon-sort"></i><span class="visually-hidden">'+MLInvoice.translate("Sort")+"</span></span>").appendTo(m);var t=MLInvoice.translate("SelectRow"),a=$("<input/>").addClass("cb-select-row").attr("type","checkbox").attr("title",t).attr("aria-label",t).on("click",function(){MLInvoice.updateRowSelectedState($(this).closest(".list_container"))});a.val(v.id);var n=$('<td class="select-row"/>');n.append(a),m.append(n)}if($.each(h.fields,function(e,t){var a=$("<td/>").addClass(t.style+(v.deleted?" deleted":""));a.data("field",t.name),a.data("th",t.name);var n=v[t.name];switch(t.type){case"LIST":case"SEARCHLIST":var i=t.name+"_text",o="";if(o=void 0!==v[i]&&null!==v[i]||void 0===_[t.name][n]?v[i]:_[t.name][n],"invoice_row"===h.type&&"product_id"===t.name){if(null!==n){var r=$("<a/>").attr("href","?func=settings&list=product&form=product&listid=list_product&id="+v[t.name]).text(o);a.append(r)}}else a.text(o);a.appendTo(m);break;case"PASSWD_STORED":a.text(""),a.appendTo(m);break;case"INT":void 0!==t.decimals?a.text(n?MLInvoice.formatCurrency(n,t.decimals):" "):a.text(n?String(n).replace(".",MLInvoice.translate("DecimalSeparator")):" "),a.appendTo(m);break;case"INTDATE":a.text(null!==n?MLInvoice.formatDate(n):" "),a.appendTo(m);break;case"CHECK":a.text(MLInvoice.translate(n?"YesButton":"NoButton")),a.appendTo(m);break;case"ROWSUM":var d=MLInvoice.calcRowSum(v),c=MLInvoice.formatCurrency(d.sum),s=MLInvoice.formatCurrency(d.VAT),l=MLInvoice.formatCurrency(d.sumVAT),p=MLInvoice.translate("VATLess")+": "+c+" + "+MLInvoice.translate("VATPart")+": "+s,u=$("<span/>").attr("title",p).text(l);a.append(u),a.appendTo(m);break;case"TAGS":var f=n?String(n):"";f=f.replace(new RegExp(/,/,"g"),", "),a.text(f),a.appendTo(m);break;case"TEXT":case"AREA":a.text(n||""),a.appendTo(m)}}),!s){var i=$("<a/>").addClass("btn btn-outline-secondary btn-sm row-edit-button").attr("role","button").attr("href","#").attr("title",MLInvoice.translate("Edit")).html('<i class="icon-pencil"></i>').on("click",function(e){return p.popupEditor(e,MLInvoice.translate("RowModification"),v.id),!1});$("<td/>").addClass("button").append(i).appendTo(m)}o.append(m)}),"invoice_row"===h.type){var a=$("<tfoot>").appendTo(t),n=function(e){for(var t=0,a=0,n=0,i=0,o=0,r=0;r<e.length;r++){var d=e[r];if(d.partial_payment)o+=parseFloat(d.price);else{var c=d.pcs,s=d.price,l=d.discount||0,p=d.discount_amount||0,u=d.vat,f=d.vat_included;null!==d.product_weight&&(i+=c*parseFloat(d.product_weight)),s*=1-l/100,s-=p;var v=0,m=0,h=0;1==f?h=(m=c*s)-(v=m/(1+u/100)):m=(v=c*s)+(h=v*(u/100)),t+=v,a+=h,n+=m}}return{totSum:t,totVAT:a,totSumVAT:n,totWeight:i,partialPayments:o}}(e.records),i=$("<tr/>").addClass("summary"),r=$("<td/>").addClass("input modify-controls").attr("colspan","6").attr("rowspan","2");s||(r.text(MLInvoice.translate("ForSelected")+": "),$("<button/>").attr("id","delete-selected-rows").addClass("btn btn-secondary selected-row-button").text(MLInvoice.translate("Delete")).on("click",function(){return p.deleteSelectedRows(),!1}).appendTo(r),r.append($("<span/>").text(" ")),$("<button/>").attr("id","update-selected-rows").addClass("btn btn-secondary selected-row-button").text(MLInvoice.translate("Modify")).on("click",function(e){return p.multiEditor(e,MLInvoice.translate("ModifySelectedRows")),!1}).appendTo(r)),r.appendTo(i),$("<td/>").addClass("input summary-heading").attr("colspan","7").text(MLInvoice.translate("TotalExcludingVAT")).appendTo(i),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totSum)).appendTo(i),$("<td/>").attr("colspan","2").appendTo(i),a.append(i),i=$("<tr/>").addClass("summary"),$("<td/>").addClass("input summary-heading").attr("colspan","7").text(MLInvoice.translate("TotalVAT")).appendTo(i),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totVAT)).appendTo(i),$("<td/>").attr("colspan","2").appendTo(i),a.append(i),i=$("<tr/>").addClass("summary"),$("<td/>").addClass("input summary-heading").attr("colspan","13").text(MLInvoice.translate("TotalIncludingVAT")).appendTo(i),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totSumVAT)).appendTo(i),$("<td/>").attr("colspan","2").appendTo(i),a.append(i),i=$("<tr/>").addClass("summary"),$("<td/>").addClass("input summary-heading").attr("colspan","13").text(MLInvoice.translate("TotalToPay")).appendTo(i),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totSumVAT+n.partialPayments)).appendTo(i),$("<td/>").attr("colspan","2").appendTo(i),a.append(i),0<n.totWeight&&(i=$("<tr/>").addClass("summary"),$("<td/>").addClass("input summary-heading").attr("colspan","13").text(MLInvoice.translate("ProductWeight")).appendTo(i),$("<td/>").addClass("input currency").text(MLInvoice.formatCurrency(n.totWeight,3)).appendTo(i),$("<td/>").attr("colspan","2").appendTo(i),a.append(i))}MLInvoice.updateRowSelectedState();var d=t.find("thead th");t.find("tbody tr:not(.summary)").each(function(){for(var e=$(this).find("td"),t=0;t<e.length;t++)$(e.get(t)).attr("data-th",$(d.get(t)).text().trim()+" ")}),s||"invoice"!==l||Sortable.create($("#itable > tbody").get(0),{direction:"vertical",draggable:"tr.item-row",handle:".sort-col",onEnd:function(){p.updateRowOrder()}}),$("#iform").find('input[type="text"],input[type="hidden"],input[type="checkbox"]:not(.cb-select-row):not(.cb-select-all),select:not(.dropdownmenu),textarea').on("change",function(){MLInvoice.highlightButton(".row-add-button",!0)}),$("#iform").find('input[type="text"],input[type="hidden"],input[type="checkbox"],select:not(.dropdownmenu),textarea').one("change",k),$("#iform_popup").find('input[type="text"],input[type="hidden"]:not(.select-default-text),input[type="checkbox"],select:not(.dropdownmenu),textarea').on("change",function(){$(this).parent().parent().find(".modification-indicator").removeClass("hidden"),$(this).data("modified",1)}),void 0!==c&&c(),h.dispatchByDateButtons&&p.updateDispatchByDateButtons(e.records)})},updateRowOrder:function(){var e={};e.table=f.type,e.order={};var t=1;$(".cb-select-row").each(function(){e.order[this.value]=t,t+=1}),$.ajax({url:"json.php?func=update_row_order",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(){MLInvoice.Form.initRows()}})},saveRow:function(o,e){MLInvoice.clearMessages();var r=$("#"+o),i={},t=void 0!==e&&e?0:r.data("rowId");$.each(f.fields,function(e,t){var a=r.find("[name="+o+"_"+t.name+"]");switch(t.type){case"CHECK":i[t.name]=a.prop("checked");break;case"INT":i[t.name]=a.val().replace(MLInvoice.translate("DecimalSeparator"),".");break;case"TAGS":case"SEARCHLIST":case"INTDATE":case"LIST":case"TEXT":case"PASSWD":case"PASSWD_STORED":i[t.name]=a.val();break;case"AREA":if(a.hasClass("markdown")){var n=a.data("mde");i[t.name]=void 0!==n?n.value():a.val()}else i[t.name]=a.val()}}),i[f.parentKey]=u.id,t&&(i.id=t);var d=f,a=this;$.ajax({url:"json.php?func=put_"+f.type,type:"POST",dataType:"json",data:JSON.stringify(i),contentType:"application/json; charset=utf-8",success:function(e){e.error?MLInvoice.errormsg(e.error):e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(MLInvoice.infomsg(MLInvoice.translate("RecordSaved"),2e3),MLInvoice.highlightButton(".row-add-button",!1),a.initRows(),r.data("popup")&&bootstrap.Modal.getInstance($("#popup_edit").get(0)).hide(),i.id||(""!==d.onAfterRowAdded&&d.onAfterRowAdded(),$.each(d.fields,function(e,t){var a=r.find("[name="+o+"_"+t.name+"]");if(void 0!==t.default&&String(t.default).startsWith("ADD+"))a.val(parseInt(a.val(),10)+parseInt(String(t.default).substr(4)));else if(void 0!==t.default&&"DATE_NOW"===t.default){var n=(new Date).toISOString().replace(/-/g,"").substr(0,8);a.val(MLInvoice.formatDate(n))}else if(d.clearAfterRowAdded)switch(t.type){case"LIST":a.val([]);break;case"SEARCHLIST":a.select2("val","");break;case"CHECK":a.prop("checked",!1);break;case"INT":case"INTDATE":case"TEXT":a.val("");break;case"AREA":if(a.hasClass("markdown")){var i=a.data("mde");void 0!==i?i.value(""):a.val("")}else a.val("")}})))}})},deleteRow:function(e){var t=$("#"+e).data("rowId");$.ajax({url:"json.php?func=delete_"+f.type+"&id="+t,type:"GET",dataType:"json",contentType:"application/json; charset=utf-8",success:function(){MLInvoice.Form.initRows(),"iform_popup"==e&&bootstrap.Modal.getInstance($("#popup_edit").get(0)).hide()}})},deleteSelectedRows:function(){var e={};e.id=$(".cb-select-row:checked").map(function(){return this.value}).get(),$.ajax({url:"json.php?func=delete_"+f.type,type:"POST",dataType:"json",data:e,success:function(){MLInvoice.Form.initRows()}})},popupEditor:function(e,t,a){k(),$("#iform_popup .modification-indicator").addClass("hidden"),$("#iform_popup input").data("modified","");var n=f;$.getJSON("json.php?func=get_"+f.type+"&id="+a,function(r){if(r.id){var d=$("#iform_popup");d.data("rowId",a),$.each(n.fields,function(e,t){var a=d.find("[name=iform_popup_"+t.name+"]");switch(t.type){case"CHECK":a.prop("checked",r[t.name]?1:0);break;case"INT":void 0!==t.decimals?a.val(r[t.name]?MLInvoice.formatCurrency(r[t.name],t.decimals):""):a.val(r[t.name]?String(r[t.name]).replace(".",MLInvoice.translate("DecimalSeparator")):"");break;case"SEARCHLIST":var n={id:r[t.name],text:r[t.name+"_text"]};a.select2("data",n);break;case"INTDATE":a.val(r[t.name]?MLInvoice.formatDate(r[t.name]):"");break;case"PASSWD_STORED":a.val("");break;case"TAGS":var i=[];$(r[t.name].split(",")).each(function(){i.push({id:this,text:this})}),a.select2("data",i);break;case"LIST":case"TEXT":a.val(r[t.name]);break;case"AREA":if(a.hasClass("markdown")){var o=a.data("mde");void 0!==o?o.value(r[t.name]):a.val(r[t.name])}else a.val(r[t.name])}});var e=$("#popup_edit");e.find(".modal-title").text(t),y(e),e.find(".edit-single-buttons").removeClass("hidden"),e.find(".edit-multi-buttons").addClass("hidden"),new bootstrap.Modal(e.get(0)).show()}})},multiEditor:function(e,t){k(),$("#iform_popup .modification-indicator").addClass("hidden"),$("#iform_popup input").data("modified",0),$("#iform_popup select").data("modified",0);var i=$("#iform_popup");$.each(f.fields,function(e,t){var a=i.find("[name=iform_popup_"+t.name+"]");switch(t.type){case"CHECK":a.prop("checked",!1);break;case"SEARCHLIST":a.select2("data",{});break;case"TAGS":a.select2("data",[]);break;case"PASSWD_STORED":case"INT":case"INTDATE":case"LIST":case"TEXT":a.val("");break;case"AREA":if(a.hasClass("markdown")){var n=a.data("mde");void 0!==n?n.value(""):a.val("")}else a.val("")}}),i.find(".modification-indicator").addClass("hidden");var a=$("#popup_edit");a.find(".modal-title").text(t),y(a),a.find(".edit-single-buttons").addClass("hidden"),a.find(".edit-multi-buttons").removeClass("hidden"),new bootstrap.Modal(a.get(0)).show()},modifyRows:function(i){MLInvoice.clearMessages();var o=$("#"+i),r={};$.each(f.fields,function(e,t){var a=o.find("[name="+i+"_"+t.name+"]");if(a.data("modified"))switch(t.type){case"CHECK":r[t.name]=a.prop("checked");break;case"INT":r[t.name]=a.val().replace(MLInvoice.translate("DecimalSeparator"),".");break;case"SEARCHLIST":r[t.name]=a.select2("data");break;case"LIST":case"INTDATE":case"TEXT":r[t.name]=a.val();break;case"AREA":if(a.hasClass("markdown")){var n=a.data("mde");r[t.name]=void 0!==n?n.value():a.val()}else r[t.name]=a.val()}});var e={};e.table=f.type,e.ids=$("#iform .cb-select-row:checked").map(function(){return this.value}).get(),e.changes=r,$.ajax({url:"json.php?func=update_multiple",type:"POST",dataType:"json",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",success:function(e){e.missing_fields?MLInvoice.errormsg(MLInvoice.translate("ErrValueMissing")+": "+e.missing_fields):(bootstrap.Modal.getInstance($("#popup_edit").get(0)).hide(),MLInvoice.Form.initRows())}})},getSelectedProductDefaults:function(e){if(null!==p){document.getElementById(e+"_description").value=p.description,v=p.description;for(var t=document.getElementById(e+"_type_id"),a=0;a<t.options.length;a++){var n=t.options[a];if(n.value===p.type_id){n.selected=!0;break}}document.getElementById(e+"_price").value=p.unit_price.replace(".",","),document.getElementById(e+"_discount").value=p.discount.replace(".",","),document.getElementById(e+"_vat").value=p.vat_percent.replace(".",","),document.getElementById(e+"_vat_included").checked=1===p.vat_included}},updateStockBalanceLog:a,printInvoice:function(e,t,a,n){if(T()){var i="invoice.php?id="+$("#record_id").val()+"&template="+e+"&func="+t;return void 0!==n&&(i+="&date="+n),void 0===$("#admin_form").data("readOnly")?MLInvoice.Form.saveRecord(i,a,!0):"openwindow"===a?window.open(i):window.location.href=i,!1}},updateDispatchByDateButtons:function(e){if("none"!==MLInvoice.getDispatchNotePrintStyle()&&!MLInvoice.isOfferStatus($("#state_id").val())){var t=$("#dispatch_date_buttons");t.empty();var a=[];$.each(e,function(e,t){if(t.reminder_row||t.partial_payment)return!0;-1===a.indexOf(t.row_date)&&a.push(t.row_date)}),a.sort();var n=this,i=function(){n.printInvoice(2,"open_invoices",MLInvoice.getDispatchNotePrintStyle(),$(this).data("date"))};for(var o in a)if(a.hasOwnProperty(o)){var r=a[o],d=$('<a class="btn btn-outline-secondary" role="button">').text(MLInvoice.translate("SettingDispatchNotes")+" "+MLInvoice.formatDate(r));d.data("date",r),d.on("click",i),t.append(d),t.append(" ")}}},setupSelect2:y,setupDefaultTextSelection:g,setupMarkdownEditor:d}});
//# sourceMappingURL=mlinvoice.min.js.map